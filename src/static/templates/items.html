{% extends "base.html" %}
{% block html_read %}


{% block javascript %}
    <script type="text/javascript">
        {% include "js/main.js" %}
    </script>
{% endblock %}
<style>

.padding-0{
    padding-right:0;
    padding-left:30px;
}

.badge-light {
    color: #212529;
    background-color: #f8f9fa;
}
</style>

  <div class="container" style="margin-top: 12px;">
      <div class="row pt-2">
        <div class="col-md-12">
          <input class="form-control mr-sm-2" id="filter" onkeyup="Search()" type="text" placeholder="Search for products by name...">
        </div>
      </div>
    <br/>
  </div>
  <div class="row col-2" style="float: left;">
    <article class="filter-group">
       Categories
      <hr>
      <div class="filter-content collapse show" id="collapse_2">
          <div class="card-body">
              {% for category in categories %}
              <label class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" onchange="filterByCategory()">
                  <div class="custom-control-label">{{category[0]}}
                    <b class="badge badge-pill badge-light float-right">{{category[1]}}</b>
                  </div>
              </label>
              {% endfor %}
          </div>
      </div>
      <hr>
    </article>
    <article class="filter-group" style="float: left;">
      Price Range
      <div class="filter-content collapse show" id="collapse_3">
        <div class="card-body">
          <input type="range" class="custom-range" min="0" max="10000" value="100" onchange="updateMaxPriceInput(this.value);"">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Min</label>
              <input class="form-control" id="minPrice" placeholder="0" value="0" type="number">
            </div>
            <div class="form-group text-right col-md-6">
              <label>Max</label>
              <input class="form-control" id="maxPrice" placeholder="10000" value="10000" type="number">
            </div>
          </div>
          <button class="btn btn-block btn-primary" onclick="filterByPrice()">Apply</button>
        </div>
      </div>
    </article>
    <article>
      <select id="sortingSelect" onchange="toggleSortingOrder()">
        <option value="asc" selected >Ascending</option>
        <option value="desc">Descending</option>
      </select>
    </article>

  </div>


<div class="row g-0 col-auto padding-0" id="mycard" style="justify-content: left;">
    {% for item in items %}
    <div class="col-lg-auto" id="cardsContainer">
    <div class="card"  id="card{{ item.id }}" data-category="{{ item.category.name.split('.')[-1] }}" style="margin: 8px; margin-bottom: 3px;">
      <div class="card-body"  style="cursor: pointer"; onclick="location.href='{{ url_for('read_item', id=item.id) }}'" >
        {% if  'no-image.png' == item.image %}
        <img class="card-img-top" src="/static/img/{{ item.image }}">
        {% else %}
        <img class="card-img-top" src="/static/img/{{ item.username }}/{{item.name}}/{{ item.image }}">
        {% endif %}
       <h5 class="card-title">{{ item.name }} </h5>
        <h6 class="card-text">Price: ${{ '%0.2f'|format(item.price|float) }}</h6>
        <input type="number" data-price={{ '%0.2f'|format(item.price|float) }} hidden>
        <h6 class="card-subtitle mb-2 text-muted">Category: {{ item.category.name.split('.')[-1] }}</h6>
      <hr>
      <div class="dropdown">
      <a href="{{ url_for('read_item', id=item.id) }}"><button class="btn btn-secondary stretched-link">Purchase Details</button></a>
    </div>
    <p>
    <span class="fa fa-star checked" id="star{{ item.id }}1"></span>
    <span class="fa fa-star checked" id="star{{ item.id }}2"></span>
    <span class="fa fa-star checked" id="star{{ item.id }}3"></span>
    <span class="fa fa-star" id="star{{ item.id }}4"></span>
    <span class="fa fa-star" id="star{{ item.id }}5"></span>
    <span id="overall-rating{{ item.id }}"> No rating Yet </span>
    </p>
      <div class="card-footer">
        <small class="text-muted">Created: {{ item.date.strftime('%Y-%m-%d') }} by {{ item.username }}</small>
      </div>
    </div>
    </div>
</div>
    {% endfor %}
  </div>


<script>
function getItemRating(item_id){
  $.ajax({
        url: "/api/reviews/item/rating",
        method: "get",
        headers: { "Content-Type": "application/json",},
        data:  { "id": `${item_id}`
        },
        success: data => {
          for (var i=1; i<=5; i++ ){
            var star = document.getElementById('star'+ item_id + i )
            if ( i <= data.rating ){
                star.classList.add('checked');
            }
            else { star.classList.remove('checked')}
          }
        document.getElementById('overall-rating'+ item_id).innerText = '  (' + data.review_number + ')'
        },
        error: (error) => {
            console.log('error:', error);
        }
      });
   }

{% for item in items %}
var item_id = '{{ item.id }}'
getItemRating(item_id)
{% endfor %}

  function Search() {
    var input, filter, cards, cardContainer, h5, title, i;
    input = document.getElementById("filter");
    filter = input.value.toUpperCase();
    cardContainer = document.getElementById("mycard");
    cards = cardContainer.getElementsByClassName("card");
    for (i = 0; i < cards.length; i++) {
        title = cards[i].querySelector(".card-body h5.card-title");
        if (title.innerText.toUpperCase().indexOf(filter) > -1) {
            cards[i].style.display = "";
        } else {
            cards[i].style.display = "none";
        }
    }
}


function updateMaxPriceInput(val) {
          document.getElementById('maxPrice').value=val; 
        }

        var allCards = [];

// Populate allCards array on page load
$(document).ready(function() {
    allCards = $(".card").toArray();
});

function getSelectedCategories() {
  var selectedCategories = [];
  var checkboxes = document.getElementsByClassName("custom-control-input");

  for (var i = 0; i < checkboxes.length; i++) {
    if (checkboxes[i].checked) {
      var categoryName = checkboxes[i].nextElementSibling.innerText.trim().split('\n')[0].toUpperCase();
      selectedCategories.push(categoryName);
    }
  }
  return selectedCategories;
}
// Function to filter cards based on category
function filterByCategory() {
    var selectedCategories = getSelectedCategories();

    allCards.forEach(function(card) {
        var category = card.getAttribute("data-category").toUpperCase();
        var displayCard = selectedCategories.length === 0 || selectedCategories.includes(category);

        if (displayCard) {
            $(card).slideDown(300);
        } else {
            $(card).slideUp(300);
        }
    });

    // Trigger sorting after filtering
    toggleSortingOrder();
}

// Function to filter cards based on price
function filterByPrice() {
    var selectedCategories = getSelectedCategories();
    var minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
    var maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

    allCards.forEach(function(card) {
        var category = card.getAttribute("data-category").toUpperCase();
        var price = parseFloat(card.querySelector("[data-price]").getAttribute("data-price"));
        var isCategoryMatch = selectedCategories.length === 0 || selectedCategories.includes(category);
        var isPriceMatch = price >= minPrice && price <= maxPrice;
        var displayCard = isCategoryMatch && isPriceMatch;

        if (displayCard) {
            $(card).slideDown(300);
        } else {
            $(card).slideUp(300);
        }
    });

    // Trigger sorting after filtering
    toggleSortingOrder();
}

// Function to toggle sorting order
function toggleSortingOrder() {
    var sortingSelect = document.getElementById("sortingSelect");
    var currentSortingOrder = sortingSelect ? sortingSelect.value : 'asc';
    var newSortingOrder = currentSortingOrder === 'asc' ? 'desc' : 'asc';

    // Sort allCards based on prices and the new sorting order
    allCards.sort(function(a, b) {
        var categoryA = a.getAttribute("data-category").toUpperCase();
        var categoryB = b.getAttribute("data-category").toUpperCase();

        if (categoryA !== categoryB) {
            // If categories are different, maintain the order based on category
            return categoryA.localeCompare(categoryB);
        }

        var priceA = parseFloat(a.querySelector("[data-price]").getAttribute("data-price"));
        var priceB = parseFloat(b.querySelector("[data-price]").getAttribute("data-price"));

        return newSortingOrder === 'asc' ? priceB - priceA : priceA - priceB;
    });
    console.log('allCards', allCards)
    // Remove all cards from the current container
    var cardsContainer = document.getElementById("cardsContainer");
    while (cardsContainer.firstChild) {
        cardsContainer.removeChild(cardsContainer.firstChild);
    }

    // Append the cards in the new order
    allCards.forEach(function(card) {
        cardsContainer.style.display = 'grid';
        cardsContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
        cardsContainer.style.gap = '10px';
        cardsContainer.appendChild(card);
    });
}
 </script>


{% endblock %}


